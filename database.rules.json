{
  "rules": {
    "rooms": {
      "$roomId": {
        // A user can read a room's data if they are a player in that room.
        ".read": "data.child('players').hasChild(auth.uid)",

        // Write is allowed if:
        // 1. Creating a new room: The room doesn't exist, and the new hostId is the creator's UID.
        // 2. Updating an existing room: The user is already a player in that room.
        ".write": "(!data.exists() && newData.child('hostId').val() === auth.uid && newData.child('players').child(auth.uid).exists()) || (data.exists() && data.child('players').hasChild(auth.uid))",

        "players": {
          "$playerId": {
            // A player can write to their own data.
            // The host can also write to any player's data (to eliminate, assign roles, etc.).
            ".write": "auth.uid === $playerId || data.parent().parent().child('hostId').val() === auth.uid"
          }
        },

        // Only the host can change critical game state properties.
        "hostId":          { ".write": "data.parent().child('hostId').val() === auth.uid" },
        "gamePhase":       { ".write": "data.parent().child('hostId').val() === auth.uid" },
        "currentQuestion": { ".write": "data.parent().child('hostId').val() === auth.uid" },
        "lastEliminated":  { ".write": "data.parent().child('hostId').val() === auth.uid" },
        "winner":          { ".write": "data.parent().child('hostId').val() === auth.uid" },

        // Any player in the room can submit answers or votes,
        // but validation ensures they can only submit for themselves.
        "answers": {
          ".write": "data.parent().child('players').hasChild(auth.uid)"
        },
        "votes": {
          ".write": "data.parent().child('players').hasChild(auth.uid)"
        }
      }
    }
  }
}
